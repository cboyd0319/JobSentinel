name: ðŸ’° Security Essentials (Lean)

on:
  push:
    branches: [main]
    paths:
      - '**/*.py'
      - 'requirements*.txt'
      - '.github/workflows/security-lean.yml'
      - 'Dockerfile'
  pull_request:
    branches: [main, develop]
    paths:
      - '**/*.py'
      - 'requirements*.txt'
      - '.github/workflows/security-lean.yml'
      - 'Dockerfile'
  workflow_dispatch:
    inputs:
      include_slow_scans:
        description: 'Include slower security scans (CodeQL, etc.)'
        required: false
        default: false
        type: boolean

env:
  FORCE_COLOR: 1

permissions:
  contents: read
  security-events: write

concurrency:
  group: security-lean-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ðŸ›¡ï¸ ESSENTIAL: Python security basics (fast & important)
  python-security-essentials:
    name: ðŸ Python Security Essentials
    runs-on: ubuntu-latest
    timeout-minutes: 8  # ðŸ’° Quick timeout
    if: github.actor != 'dependabot[bot]'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1  # ðŸ’° Shallow clone
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: ðŸ“¦ Install Security Tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] safety
      
      - name: ðŸ” Bandit Security Scan
        id: bandit
        run: |
          echo "ðŸ” Running Bandit security scan..."
          bandit -r src/ utils/ sources/ notify/ matchers/ -f json -o bandit-report.json || true
          bandit -r src/ utils/ sources/ notify/ matchers/ -f txt
        continue-on-error: true
      
      - name: ðŸ”’ Check for Known Vulnerabilities
        id: safety
        run: |
          echo "ðŸ”’ Checking for known vulnerabilities in dependencies..."
          safety check --json --output safety-report.json || true
          safety check
        continue-on-error: true
      
      - name: ðŸ“¤ Upload Security Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports-lean
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 14  # ðŸ’° Shorter retention for personal project

  # ðŸ›¡ï¸ DEPENDENCY: Simple dependency check (essential for any project)  
  dependency-check-basic:
    name: ðŸ“¦ Dependency Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 5  # ðŸ’° Very quick
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      
      - name: ðŸ” Check for Vulnerable Dependencies
        run: |
          echo "ðŸ“¦ Checking Python dependencies..."
          
          # Check requirements files exist
          for req_file in requirements.txt requirements-*.txt; do
            if [[ -f "$req_file" ]]; then
              echo "ðŸ“‹ Found: $req_file"
              
              # Simple vulnerability check using pip-audit (lightweight alternative)
              if command -v pip-audit >/dev/null 2>&1; then
                echo "ðŸ” Scanning $req_file with pip-audit..."
                pip-audit -r "$req_file" || echo "âš ï¸ Vulnerabilities found in $req_file"
              else
                echo "ðŸ“¦ Installing pip-audit..."
                python -m pip install pip-audit
                echo "ðŸ” Scanning $req_file..."
                pip-audit -r "$req_file" || echo "âš ï¸ Vulnerabilities found in $req_file"
              fi
            fi
          done

  # ðŸ›¡ï¸ OPTIONAL: Slower scans (only if requested manually)
  advanced-security:
    name: ðŸ”¬ Advanced Security Scans
    runs-on: ubuntu-latest
    timeout-minutes: 15  # ðŸ’° Limited timeout even for advanced scans
    if: |
      github.event.inputs.include_slow_scans == 'true' &&
      github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5
      
      - name: ðŸ”¬ Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          config-file: ./.github/codeql/codeql-config.yml
        continue-on-error: true
      
      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v4
        continue-on-error: true
      
      - name: ðŸ”¬ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        continue-on-error: true

  # ðŸ“Š SUMMARY: Quick security summary
  security-summary:
    name: ðŸ“Š Security Summary
    runs-on: ubuntu-latest
    needs: [python-security-essentials, dependency-check-basic]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸ›¡ï¸ Security Scan Results (Lean Version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Scans Completed" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Security**: ${{ needs.python-security-essentials.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Check**: ${{ needs.dependency-check-basic.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.python-security-essentials.result }}" == "success" && "${{ needs.dependency-check-basic.result }}" == "success" ]]; then
            echo "### âœ… Security Status: GOOD" >> $GITHUB_STEP_SUMMARY
            echo "No critical security issues detected in essential scans." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Security Status: REVIEW NEEDED" >> $GITHUB_STEP_SUMMARY
            echo "Some security scans detected issues. Review the job logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review any security findings in the job logs" >> $GITHUB_STEP_SUMMARY
          echo "- For comprehensive scanning, run: \`gh workflow run security-lean.yml -f include_slow_scans=true\`" >> $GITHUB_STEP_SUMMARY
          echo "- Consider running full scans before major releases" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’° Cost Optimization" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Fast essential scans only (~3-8 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Advanced scans available on-demand" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Minimal artifact storage (14 days)" >> $GITHUB_STEP_SUMMARY